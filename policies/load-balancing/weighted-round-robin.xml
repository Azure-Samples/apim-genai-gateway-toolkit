<fragment>
	<set-variable name="all-endpoints" value="@{
                JArray endpoints = new JArray();
                endpoints.Add(new JObject()
                {
                    { "url", "{{payg-endpoint-1}}" },
                    { "weight", 2 },
                });

                endpoints.Add(new JObject()
                {
                    { "url", "{{payg-endpoint-2}}" },
                    { "weight", 3 },
                });

                return endpoints;
            }" />
	<set-variable name="selected-url" value="@{
        var endpoints = (JArray)context.Variables["all-endpoints"];
            var totalWeight = endpoints.Sum(e => (int)e["weight"]);
            var randomNumber = new Random().Next(totalWeight);
            var weightSum = 0;
            foreach (var endpoint in endpoints)
            {
                weightSum += (int)endpoint["weight"];
                if (randomNumber < weightSum)
                {
                    return endpoint["url"].ToString();
                }
            }
            return endpoints[0]["url"].ToString();
    }" />
    <set-header name="api-key" exists-action="override">
        <value>{{ptu-key-1}}</value>
    </set-header>
	<set-backend-service base-url="@((string)context.Variables["selected-url"])" />
</fragment>