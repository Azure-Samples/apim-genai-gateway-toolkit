<fragment>
    <retry condition="@(context.Response.StatusCode == 429)"
        count="3"
        interval="1"
        max-interval="10"
        delta="2">
        <choose>
            <!-- use less preferred backend on the retry -->
            <when condition="@(context.Response.StatusCode == 429)">
                <set-variable name="preferred-url"
                    value="@((string)context.Variables["lessPreferredBackend"])" />
            </when>
            <otherwise>
                <set-variable name="preferred-url"
                    value="@((string)context.Variables["mostPreferredBackend"])" />
            </otherwise>
        </choose>
        <set-variable name="selected-url"
            value="@(String.IsNullOrEmpty((string)context.Variables["preferred-url"]) ? (string)context.Variables["default-url"] : (string)context.Variables["preferred-url"])"/>
        <set-header name="api-key" exists-action="override">
            <value>{{ptu-key-1}}</value>
        </set-header>
        <set-backend-service base-url="@((string)context.Variables["selected-url"])" />
        <forward-request timeout="120"
            fail-on-error-status-code="true"
            buffer-response="false" />
    </retry>
</fragment>